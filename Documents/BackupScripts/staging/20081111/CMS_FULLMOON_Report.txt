select  cahd.vess_code vessel, 
        cahd.tx_date tx_date,
        cahd.tx_no tx_no,
        sum(calo.tot_catch) total_catch, 
        sf_is_fullmoon(cahd.tx_date) is_fullmoon,
        decode(sf_is_fullmoon(cahd.tx_date), 1, 
             decode(greatest(sum(calo.tot_catch),299.9),299.9,0,1),  
             decode(greatest(sum(calo.tot_catch),599.9),599.9,0,1)
             ) passed
from    cms_catches_hdr cahd, cms_catches_log calo
where   cahd.tx_no = calo.cahd_tx_no
and     cahd.tx_date BETWEEN :P_FROM_DATE AND :P_TO_DATE
group   by cahd.vess_code, 
        cahd.tx_date,
        cahd.tx_no
union
select  cahd.vess_lighted vessel,
        cahd.tx_date tx_date,
        cahd.tx_no tx_no,
        decode(cahd.vess_lighted,cahd.vess_code, 0,
        decode(cahd.vess_lighted,cahd.vess_surveyed, sum(calo.tot_catch), sum(calo.tot_catch)/2)) total_catch, 
        sf_is_fullmoon(cahd.tx_date) is_fullmoon,
        decode(sf_is_fullmoon(cahd.tx_date), 1, 
             decode(greatest(decode(cahd.vess_lighted,cahd.vess_surveyed, sum(calo.tot_catch), sum(calo.tot_catch)/2),299.9),299.9,0,1),  
             decode(greatest(decode(cahd.vess_lighted,cahd.vess_surveyed, sum(calo.tot_catch), sum(calo.tot_catch)/2),599.9),599.9,0,1)
             ) passed
from    cms_catches_hdr cahd, cms_catches_log calo
where   cahd.tx_no = calo.cahd_tx_no
and     cahd.tx_date BETWEEN :P_FROM_DATE AND :P_TO_DATE
group   by cahd.vess_lighted,
        cahd.vess_surveyed,
        cahd.vess_code, 
        cahd.tx_date,
        cahd.tx_no
union
select  cahd.vess_surveyed vessel,
        cahd.tx_date tx_date,
        cahd.tx_no tx_no,
        sum(calo.tot_catch)/2 total_catch, 
        sf_is_fullmoon(cahd.tx_date) is_fullmoon,
        decode(sf_is_fullmoon(cahd.tx_date), 1, 
             decode(greatest(sum(calo.tot_catch)/2,299.9),299.9,0,1),  
             decode(greatest(sum(calo.tot_catch)/2,599.9),599.9,0,1)
             ) passed
from    cms_catches_hdr cahd, cms_catches_log calo
where   cahd.tx_no = calo.cahd_tx_no
and     cahd.vess_lighted <> cahd.vess_surveyed
and     cahd.tx_date BETWEEN :P_FROM_DATE AND :P_TO_DATE
group   by cahd.vess_surveyed, 
        cahd.tx_date,
        cahd.tx_no



select code as vessel_code, name as vessel_name
from cms_vessels t
where exists (
select 1 vess_code 
from cms_catches_hdr h, cms_catches_log d 
where h.tx_date between  :p_from_date and :p_to_date  
and   (h.vess_code= t.code
or     h.vess_lighted= t.code
or     h.vess_surveyed= t.code )
group by h.vess_code 
having sum(d.tot_catch) > 0
)
order by name


select code as vessel_code, name as vessel_name
from cms_vessels t
where exists (
select 1 from (
select h.vess_code vess_code from cms_catches_hdr h, cms_catches_log d where h.tx_no=d.cahd_tx_no and h.tx_date between :p_from_date and :p_to_date group by h.vess_code having sum(d.tot_catch) > 0
union
select h.vess_lighted vess_code from cms_catches_hdr h, cms_catches_log d where h.tx_no=d.cahd_tx_no and h.tx_date between :p_from_date and :p_to_date group by h.vess_lighted having sum(d.tot_catch) > 0
union
select h.vess_surveyed vess_code from cms_catches_hdr h, cms_catches_log d where h.tx_no=d.cahd_tx_no and h.tx_date between :p_from_date and :p_to_date group by h.vess_surveyed having sum(d.tot_catch) > 0
) v
where v.vess_code= t.code
)
order by name
